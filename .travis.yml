language: php

php:
  - 7.1

env:
  - VALIDATION=false
  - VALIDATION=true

os:
  - linux

matrix:
  fast_finish: true
  allow_failures:
    - env: VALIDATION=true

cache: false

git:
  submodules: false

before_script:
  - phpenv config-rm xdebug.ini
#  - phpenv config-add php-custom.ini
  - if find . -name "*.php" -path "./src/*" -path "./experiments/*" -path "./tools/*" -path "./syntax-visualizer/server/src/*" -exec php -l {} 2>&1 \; | grep "syntax error, unexpected"; then exit 1; fi  
  - if find . -name "*.php" -path "./tests/*" -path "./validation/*" -maxdepth 0 --exec php -l {} 2>&1 \; | grep "syntax error, unexpected"; then exit 1; fi    
  - if [[ $VALIDATION = true ]]; then git submodule update --init --recursive; fi
  - composer install

script:
  - |
    set -e
    
    if [[ $VALIDATION = true ]]; then
      php -c vendor\phpunit\phpunit\phpunit --testsuite validation
    else
      php -c vendor\phpunit\phpunit\phpunit --testsuite invariants
      php -c vendor\phpunit\phpunit\phpunit --testsuite grammar
      php -c vendor\phpunit\phpunit\phpunit --testsuite api
    fi
